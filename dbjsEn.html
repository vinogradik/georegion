	<html lang = ru>
<head>
	<link rel="stylesheet" type="text/css" href="CSS/style.css">
  	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
   <title> Database </title>
   <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
	<script src="http://code.jquery.com/ui/1.11.1/jquery-ui.min.js"></script>
   <script src="JS/genQueryEn.js"></script>
   <link href="CSS/google-code-prettify/prettify.css" type="text/css" rel="stylesheet" />
	<script type="text/javascript" src="CSS/google-code-prettify/prettify.js"></script>
     <script>	
   	$(document).ready(function() {
   		var primaryTable = "METEO_DATA_2015_WREGIONS";
   		$('select#chooseTable').on('change', function() {
   			$(".error").hide();
   			$("div.forTable").hide();
   			$(".result").hide();
   			primaryTable = this.value;
   			$("div#" + primaryTable).show();
			})
   		
   		$("input").change(function () {
   			$(".result")[0].style.opacity = 0.5;
   		})
   		
			$("input.functions").change(function(e) {
				switch ($("input." + primaryTable +".functions:checked").length) {
				case 1:
					if (primaryTable == "METEO_DATA_2015_WREGIONS")					
						$(".withAd").fadeIn();
					break;
				case 0:
					if (primaryTable == "METEO_DATA_2015_WREGIONS") {					 
						$(".withAd").fadeOut();
						resetHiddenPart();
					}
					break;
				default: 
					$("input." + primaryTable + ".functions:checked").each(function () {
						$(this).prop("checked", false);
					});
					$("#" + e.target.id + "." + primaryTable).prop("checked", true);
				}				
			});
			
			
			$(document).on('change', 'input.REGIONList', function(){
				
				var j = 0;

				while (this.value != groups[0][2][j])
					j++;
				if (j > 0) 
					if (this.checked) 
						$("#" + groups[0][2][j]).fadeIn();
					else  
						$("#" + groups[0][2][j]).fadeOut(); 	
    		});			
			
			$("input.Group").change(function(e){
				if ($("input#LR:checked").length == 1)  
					$("input.notLR:checked").each(function(){
						$(this).prop("checked", false);	
					});
				var i = 0;
				while (this.id != "Group" + groups[i][0])
					i++;
				if (this.checked == true) 
					customDialog(i);
         	else {
         		document.getElementById("Group" + groups[i][0] + "List").innerHTML = "";
         		FormSerialised[i] = "";
         		AdFormData[i] = {};
         		if ($("#your-dialog").hasClass('ui-dialog-content')) 
         			$("#your-dialog").dialog("close");
         	}
			});
			
			$(document).on("submit", "form.AdForm", function(e){
				e.preventDefault();
				var i = 0;
				while (this.id != groups[i][0])
					i++;
				AdFormData[i] = getFormDataArray(this);
				var errorType = ValidateAdFormJS(i);
        		if (errorType == -1){   	
      			str = "";
         		$("input." + groups[i][0] + "List").each(function(){
         			if (this.checked == true) {
            			var j = 0;
							while ($(this).val() != groups[i][2][j])
								j++;
							if(str.length == 0)
								str += "+ ";
							else 
								str += ", ";
           				str += groups[i][3][j];
           			}
        			});
					if (str.length != 0) 
						str += ";"
						       			
        			str += "<a class = 'AdFormChange' id = '" + groups[i][0] + "ListChange'> change</a>"
     				document.getElementById("Group" + groups[i][0] + "List").innerHTML = str;
         		$("#your-dialog").dialog("close");
         		FormSerialised[i] = $(this).serialize();
         	}
         	else 
         		alert('please check filter "years" of the parameter "' + groups[i][3][errorType] + '"');
      	});
      	
      	$(document).on("click", "a.AdFormChange", function(){
      		i = 0; 
      		while (this.id != groups[i][0] + "ListChange")
      			i++;
      		customDialog(i);
      	});
			
			$("input#LR").change(function(){
				var x = $("p.notLR");
				if (this.checked) {
					$("input.notLR:checked").each(function(){
						$(this).prop("checked", false);	
					});
					for (i = 0; i < x.length; i++)
						x[i].style.opacity = 0.5;
				}
				else {
					for (i = 0; i < x.length; i++) 
						x[i].style.opacity = 1;
				}					
			});
			
			
			
			$("input[name = extractType]").change(function(){
				if ($("input[name = extractType]:checked").val() == 1) {
					$("#filename").show();
					$("#TableSize").hide();
				}
				else {
					$("#TableSize").show();
					$("#filename").hide();
				}
			});
			
			
			$("form#Main").submit(function(e) {
				e.preventDefault();
				var errorType = ValidateFormJS(primaryTable);
				/*if($("form#Main").data("preverror") && $("form#Main").data("preverror") > 0 && $("form#Main").data("preverror") != errorType) {
					prevErr = $("form#Main").data("preverror") - 1;
					document.getElementById("new" + names[prevErr][0]).className = document.getElementById("new" + names[prevErr][0]).className.replace(" error", "");
				}*/
		
				if (errorType == -1) {
					$(".error").hide();
					$(".modal").show();
					$(".result")[0].style.opacity = 1;
					$(".result").fadeIn();
					
					var sentData = $('form#Main').serialize();
					for (i = 0; i < groups.length; i++)
						if (FormSerialised[i].length > 0) 
							sentData += "&" + FormSerialised[i];
          		$.post('PHP/serverEn.php', sentData, function(retData) {
          			if ($("input[name = extractType]:checked").val() == 1)
  							$("body").append("<iframe src='PHP/DownloadCSV.php' style='display: none;' ></iframe>");
  						$(".modal").hide();
  						$(".result").html(retData);
  						prettyPrint();
  						$("html, body").animate({ scrollTop: $(document).height() - $(window).scrollTop() }, "slow");
					}); 
          	}
    			else { 
    				$(".error").show();
    				$(".result").hide();
    				if (errorType == -2)
    					document.getElementsByClassName("error")[0].innerHTML = 'Error: nothing chosen.';
    				else	{
    					var it = 0;
						while(primaryTable != tables[it][0])
							it++;
    					document.getElementsByClassName("error")[0].innerHTML = 'Error in filter "' + tables[it][3][errorType] + '"';    					
    					//document.getElementById("new" + names[errorType][0]).className += " error";
    					//$("#new" + names[errorType][0]).show();
					}    				
    				$("html, body").animate({ scrollTop: 0 }, "slow");
    			}
    			$("form#Main").data({preverror: (errorType + 1), windowPosition: $("body").scrollTop()});
    			
			});
			$(document).on("click", "a#english", function(){
				window.location = "dbjs.html";
			});
		});
   </script>	   
</head>
<body>
<p class = "error" hidden></p>
<form id = "Main">
	<fieldset  id = "chooseTable" class  = "main"></fieldset>	
	<div class = "forTable" id = "METEO_DATA_2015_WREGIONS">
	<fieldset id = 'kek1' class  = "main"></fieldset>
	<fieldset id = "kek3" class  = "main"></fieldset>
	<fieldset class = "main withAd" hidden class  = "main">
		<legend>Linear regression</legend>
		<input type = "checkbox" name = "LR" value = "LR" id = "LR" autocomplete = "off"> count angular coefficient of the trend line<br>
	</fieldset>
	<fieldset class = "main withAd" id = "kek4" hidden></fieldset>
	</div>
	<div id = "otherTables"></div>
	<fieldset class  = "main">
		<legend>Output parameters</legend>
		<p><input type = "radio" name = "extractType" value = "0" checked autocomplete = "off">preview</p>
		<p><input type = "radio" name = "extractType" value = "1" autocomplete = "off">output into file</p>
		<p id = "TableSize"><input type = "number" min = 0 value = "10" name = "TableSize"> number of lines in the output</p>
		<p  id = "filename" hidden><input type = "text" name = "filename" placeholder = "data.csv"> filename</p>
	</fieldset>
	<input type="submit" name = "SubmitAll" value="Go" id = "SubmitAll">
</form>
<script>
	var text = "<legend>Choose the main table</legend>";
	text += "<select class = 'short' id = 'chooseTable' name = 'primaryTable' autocomplete = 'off'>";	
	for (i = 0; i < tables.length; i++)
		text += "<option value = '" + tables[i][0] + "'>" + tables[i][1] + "</option>";
	text += "</select>";
	
	$("fieldset#chooseTable").html(text);
	
	text = "<legend>Choose columns from the database and filters for them</legend>";

	text += "<p>from <input type='number' min = '1800' max = '2100' placeholder = 'year' id = 'lYEARl' name = 'YEAR[]'> ";
	text += "<input type='number' min = '1' max = '12' placeholder = 'month' id = 'lMONTHl' name = 'MONTH[]'> ";
	text += "<input type='number' min = '1' max = '31' placeholder = 'day' id = 'lDAYl' name = 'DAY[]'> ";
	
	text += "to <input type='number' min = '1800' max = '2100' placeholder = 'year' id = 'rYEARr' name = 'YEAR[]'> ";
	text += "<input type='number' min = '1' max = '12' placeholder = 'month' id = 'rMONTHr' name = 'MONTH[]'> ";
	text += "<input type='number' min = '1' max = '31' placeholder = 'day' id = 'rDAYr' name = 'DAY[]'> ";

	text +="<input type='checkbox' name = 'Columns[]' class = 'cols' id = 'DAYS' value = 'DAYS'> date</p>";
	 
	text += "<select id = 'method' class = 'short' name = 'DateType'>";
   text += "<option value='method1'>variant 1</option>";
   text += "<option value='method2'>variant 2</option>";
	text += "</select><a href = '/INFO/info.html'>*</a>";

	for (i = 1; i < names.length; i++) {
		text += "<p>";
		text += "from <input class = 'METEO_DATA_2015_WREGIONS filters' type='number'  step = '0.1' lang = 'eng' placeholder = 'min' id = 'l" + names[i][0] + "' name = '" + names[i][0] + "[]'> "; 
		text += "to <input class = 'METEO_DATA_2015_WREGIONS filters' type='number'  step = '0.1' lang = 'eng' placeholder = 'max' id = 'r" + names[i][0] + "' name = '" + names[i][0] + "[]'> ";
		text +="<input class = 'METEO_DATA_2015_WREGIONS columns' type='checkbox' name = 'Columns[]' class = 'cols' id = '"  + names[i][0] + "' value = '"  + names[i][0] + "'>" 
			+ names[i][1] + "</p>";
	}
	document.getElementById("kek1").innerHTML = text;
	text = "<legend>Functions</legend>";
	for (i = 0; i < functions.length; i++) 
		text += "<p><input type = 'checkbox' name = 'Functions[]' class = 'METEO_DATA_2015_WREGIONS functions' value = '" 
			+ functions[i][0] + "' id = '"+ functions[i][0] + "'>" + functions[i][1] + "</p>";
	document.getElementById("kek3").innerHTML = text;
	text = "<legend>Group data by</legend>";
	for (i = 0; i < groups.length; i++) {
		notLR = "";
		if (i > 1)
			notLR = "notLR";
		text += "<p class = '" + notLR + "'><input type = 'checkbox' name = 'Groups[]'  id = 'Group" +groups[i][0] 
			+ "' class = 'Group " + notLR + "' value = '" + groups[i][0] + "' autocomplete = 'off'>" + groups[i][1] + "</p>";
		text += "<p class = 'GroupLists' id = Group" + groups[i][0] + "List></p>";
	}
	document.getElementById("kek4").innerHTML = text;
	
	
	
	for (i = 1; i < tables.length; i++) {		
		text = "<div class = 'forTable' id = '" + tables[i][0] + "' hidden></div>";
		$("div#otherTables").append(text);
		
		//columns		
		text = "<fieldset id = 'columns' class = 'main " + tables[i][0] + "'></fieldset>";
		$("div#" + tables[i][0]).append(text);
			
		text = "<legend>Choose columns from the database and filters for them</legend><table class = 'columns_filters'>";
		var k = 0;
		for (p = 0; p < tables[i][2].length; p++) {
			text += "<tr><td class = 'left'>";
			if (i > 1 && EDataCols[i - 2][0].length > k + 1 && EDataCols[i - 2][0][k] == tables[i][2][p]) {
				text += "<select class = '" + tables[i][0] + " filters' id = '" + tables[i][2][p] + "' name = '" + tables[i][0] + tables[i][2][p] + "'>";
				for (l = 0; l < EDataCols[i - 2][1][k].length; l++) {
   				text += "<option value = '" + EDataCols[i - 2][1][k][l] + "'>" + EDataCols[i - 2][1][k][l] + "</option>";
   			}
   			text += "</select>";
   			k++;
   		}
   		else
   		if (i != 2 || p != 1){
					text += "from <input type='number' class = '" + tables[i][0] +" filters' id = 'l" + tables[i][2][p] + "' name = '" + tables[i][0] + tables[i][2][p] + "L' step = '1' min = '' max = '' lang = 'eng' placeholder = 'min'> "; 
					text += "to <input type='number' class = '" + tables[i][0] +" filters' id = 'r" + tables[i][2][p] + "' name = '" + tables[i][0] + tables[i][2][p] + "R' step = '1' min = '' max = '' lang = 'eng' placeholder = 'max'>";				
			}
			text += "</td><td><input type = checkbox class = '" + tables[i][0] +" columns' id = '" + tables[i][2][p] + "' name = '" + tables[i][0] + "Columns[]' value = '" + tables[i][2][p] + "'> " + tables[i][3][p] + "</input></td></tr>";
		}		
		text += "</table>";
		$("fieldset#columns." + tables[i][0]).html(text);
		
		//functions
		if (i != 2) {
			text = "<fieldset id = 'functions' class = 'main " + tables[i][0] + "'></fieldset>";
			$("div#" + tables[i][0]).append(text);
			text = "<legend>Functions</legend>";
			for (k = 0; k < functions.length; k++)
				text += "<input type = checkbox class = '" + tables[i][0] +" functions' id = '" + functions[k][0] +"' name = '" + tables[i][0] + "Functions[]' value = '" + functions[k][0] + "'> " + functions[k][1] + "</input><br>";
			$("fieldset#functions." + tables[i][0]).html(text);
		}
	}	
	
</script>
<p class = "result" hidden></p>
<div class='modal' hidden></div>
<p id = "demo"></p>
<div class = "centered_div"></div>
<div id = 'your-dialog'></div>
<div id = "info"></div>
<div id = "language">
<a id = "english"> 
 <img src="IMG/united-kingdom.png">
</a>
</div>
</body>
</html>
